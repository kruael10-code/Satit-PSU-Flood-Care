import { StudentReport } from '../types';

// üö® ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å: Web App URL ‡∏à‡∏≤‡∏Å Google Script ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß)
const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzg0TICyh4Kr07KdPJFXWK8vb4-wlc5BEOmGNKompvZwZNXA2EDyJfJcUtD6G5DcEmKqg/exec';

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Ç‡∏≤‡πÑ‡∏õ)
export const sendReportToGoogleSheet = async (data: StudentReport) => {
  try {
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô Format ‡∏ó‡∏µ‡πà Google Sheet ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢‡πÜ
    const payload = {
      timestamp: new Date().toLocaleString('th-TH'), // ‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏ó‡∏¢
      id: data.id,
      name: data.studentName,
      phone: data.phoneNumber || '-',     // ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£ (‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏™‡πà -)
      dorm: data.dormitory,
      category: data.category,
      risk: data.riskLevel,
      message: data.message,
      location: data.location ? `${data.location.latitude}, ${data.location.longitude}` : '-',
      status: data.isResolved ? 'Solved' : 'Pending'
    };

    // ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ
    await fetch(GOOGLE_SCRIPT_URL, {
      method: 'POST',
      mode: 'no-cors', // ‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡∏ô‡∏µ‡πâ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ Browser ‡∏ö‡∏•‡πá‡∏≠‡∏Å
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload),
    });

    console.log("‚úÖ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ Google Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
  } catch (error) {
    console.error("‚ùå ‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏ú‡πà‡∏≤‡∏ô:", error);
  }
};

// ‚ú® ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Ç‡∏≤‡∏Å‡∏•‡∏±‡∏ö) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏Ñ‡πà‡∏∞
export const fetchReportsFromSheet = async (): Promise<StudentReport[]> => {
  try {
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏õ‡∏ó‡∏µ‡πà URL ‡πÄ‡∏î‡∏¥‡∏° (Google Script ‡∏à‡∏∞‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô doGet)
    const response = await fetch(GOOGLE_SCRIPT_URL);
    
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const data = await response.json();
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö StudentReport ‡∏ó‡∏µ‡πà‡πÅ‡∏≠‡∏û‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
    return data.map((item: any) => ({
        id: item.id,
        studentName: item.studentName,
        phoneNumber: item.phoneNumber,
        dormitory: item.dormitory,
        // ‡πÅ‡∏õ‡∏•‡∏á Timestamp ‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Date Object
        timestamp: new Date(item.timestamp || Date.now()), 
        message: item.message,
        category: item.category,
        riskLevel: item.riskLevel,
        location: item.location,
        isResolved: item.isResolved
    })).reverse(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏≠‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡πà‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤ Sheet ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏Å‡πà‡∏≤‡πÑ‡∏õ‡πÉ‡∏´‡∏°‡πà)

  } catch (error) {
    console.error("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Sheet ‡πÑ‡∏î‡πâ:", error);
    return []; // ‡∏ñ‡πâ‡∏≤ Error ‡πÉ‡∏´‡πâ‡∏™‡πà‡∏á‡∏≠‡∏≤‡πÄ‡∏£‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏≠‡∏û‡∏à‡∏∞‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡∏û‡∏±‡∏á
  }
};